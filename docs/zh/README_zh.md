# TurboStream
<div align="center">
<img src="https://img.shields.io/badge/Go-1.23+-00ADD8?logo=go&logoColor=white" alt="Go Version">
<img src="https://img.shields.io/badge/license-Apache2.0-blue" alt="License">
<img src="https://img.shields.io/badge/performance-optimized-brightgreen" alt="Performance">
<a title="Tag" target="_blank" href="https://github.com/TimeWtr/TurboStream/tags"><img src="https://img.shields.io/github/v/tag/TimeWtr/TurboStream?color=%23ff8936&logo=fitbit&style=flat-square" /></a>
<br/>
<a title="Doc for Poolx" target="_blank" href="https://pkg.go.dev/github.com/TimeWtr/TurboStream?tab=doc"><img src="https://img.shields.io/badge/go.dev-doc-007d9c?style=flat-square&logo=read-the-docs" /></a>
<img src="https://goreportcard.com/badge/github.com/TimeWtr/TurboStream" alt="Go Report">

[//]: # (<img src="https://img.shields.io/codecov/c/github/TimeWtr/TurboStream?logo=codecov" alt="Coverage">)
</div>


åŸºäºGo Sliceã€Buffer Poolå’Œé›¶æ‹·è´å®ç°çš„é«˜æ€§èƒ½åŒç¼“å†²é€šé“ã€‚

## ğŸ“Š Features
ğŸ”¹ **åŒå†™ç¼“å†²åŒºè®¾è®¡**ï¼šactiveé€šé“ç”¨äºå®æ—¶æ¥æ”¶æ•°æ®ï¼Œpassiveé€šé“ç”¨äºå¼‚æ­¥å¤„ç†æ•°æ®ï¼Œå½“activeæ»¡è¶³
åˆ‡æ¢é€»è¾‘æ‰§è¡Œé€šé“è½®è½¬åï¼Œpassiveè½¬æ¢ä¸ºactiveå®æ—¶å†™å…¥é€šé“æ¥æ”¶æ•°æ®ï¼Œactiveè½¬æ¢æˆpassiveå¼‚æ­¥å¤„ç†é€šé“ã€‚

ğŸ”¹ **æ¶ˆæ¯å…¨å±€æœ‰åºç‰¹æ€§**ï¼šæ¯æ¡æ¶ˆæ¯çš„æŒ‰ç…§é¡ºåºå†™å…¥åˆ°activeé€šé“ä¸­ï¼Œå½“é€šé“åˆ‡æ¢æ—¶activeè½¬æ¢ä¸ºpassiveï¼Œ
åˆ‡æ¢ç¨‹åºä¼šä¸ºpassiveåˆ†é…ä¸€ä¸ªå…¨å±€å”¯ä¸€å•è°ƒé€’å¢çš„åºåˆ—å·ï¼Œå¹¶å°†passiveæ·»åŠ åˆ°å°é¡¶å †ä¸­ï¼Œå°é¡¶å †æ ¹æ®åºåˆ—å·
è¿›è¡Œæ’åºï¼Œæ¶ˆè´¹æ•°æ®æ—¶ä¼šæŒ‰ç…§åºåˆ—å·é¡ºåºæ¥æ¶ˆæ¯ã€‚

ğŸ”¹ **çµæ´»çš„é€šé“åˆ‡æ¢ç­–ç•¥**ï¼š

- **é»˜è®¤åˆ‡æ¢ç­–ç•¥ï¼ˆå¤æ‚ç­–ç•¥ï¼‰**ï¼š
    - å½“activeé€šé“ä¸­æ•°æ®æ¡æ•°è¶…è¿‡å®¹é‡é™åˆ¶ï¼Œç«‹å³è½®è½¬ã€‚
    - å½“è¾¾åˆ°ä¸€å®šæ—¶é—´ï¼Œå³å½“å‰æ—¶é—´è·ç¦»ä¸Šæ¬¡è½®è½¬æ—¶é—´è¾ƒé•¿ï¼Œè¶…è¿‡äº†æ—¶é—´çª—å£å‘¨æœŸç«‹å³è¿›è¡Œè½®è½¬ï¼Œé˜²æ­¢å› é•¿æœŸæ²¡æœ‰æ–°æ•°æ®å†™å…¥
      å¯¼è‡´æ¥æ”¶æ–¹æ— æ³•è·å–é€šé“å†…æ•°æ®çš„é—®é¢˜ï¼Œä¹Ÿå°½å¯èƒ½å‡å°‘æ•°æ®ä¸¢å¤±çš„é£é™©ã€‚
    - ç»¼åˆç­–ç•¥ï¼Œæ—¶é—´å› å­(40%)ã€æ•°æ®æ¡æ•°å› å­(60%)ï¼Œæ ¹æ®ç»¼åˆå› å­åˆ¤æ–­æ˜¯å¦è¿›è¡Œé€šé“è½®è½¬ã€‚
- **æ—¶é—´åˆ‡æ¢ç­–ç•¥**ï¼šå½“å½“å‰æ—¶é—´ä¸ä¸Šæ¬¡åˆ‡æ¢çš„æ—¶é—´å·®å€¼è¶…è¿‡äº†åˆ‡æ¢æ—¶é—´çª—å£æ—¶è¿›è¡Œåˆ‡æ¢ã€‚
- **æ•°æ®é‡åˆ‡æ¢ç­–ç•¥**ï¼šå½“æ´»è·ƒç¼“å†²åŒºä¸­çš„æ•°æ®è¶…è¿‡é€šé“å®¹é‡æ—¶è¿›è¡Œåˆ‡æ¢ã€‚

ğŸ”¹ **æ— é”åŒ–è®¾è®¡**ï¼šåŒç¼“å†²é€šé“ä¸ä½¿ç”¨åŠ é”ä¿æŠ¤é€šé“åˆ‡æ¢ï¼Œä½¿ç”¨åŸå­çŠ¶æ€å®ç°å¹¶å‘å®‰å…¨çš„é€šé“åˆ‡æ¢ï¼Œå¤§å¤§æå‡äº†æ€§èƒ½ã€‚

ğŸ”¹ **ç¼“å†²æ± è®¾è®¡**ï¼šä½¿ç”¨ç¼“å†²æ± è®¾è®¡ï¼Œé€šé“åˆ‡æ¢æ—¶å¤ç”¨æ± ä¸­å¯ç”¨é€šé“ï¼Œé˜²æ­¢å‡ºç°é¢‘ç¹çš„é€šé“åˆ›å»ºå’Œé”€æ¯çš„å¼€é”€ã€‚

ğŸ”¹ **å¼‚æ­¥æ‰¹é‡å”¤é†’åè°ƒå™¨**ï¼šé˜»å¡å¼è¯»å–APIæ—¶ï¼Œå¦‚æœæ²¡æœ‰å¯è¯»æ•°æ®ä¼šé˜»å¡ç­‰å¾…æ•°æ®ï¼ŒAPIæ³¨å†Œé€šçŸ¥é€šé“åˆ°åè°ƒå™¨ï¼Œå½“é€šé“åˆ‡æ¢æ—¶åˆ†æ‰¹æ¬¡
é€šçŸ¥APIè¯»å–æ•°æ®ï¼ŒAPIé‡‡ç”¨å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œå½“contextè¶…æ—¶ã€åŒç¼“å†²é€šé“å…³é—­æ—¶è¿”å›é”™è¯¯ï¼Œæ”¶åˆ°é€šçŸ¥åˆ™å¤„ç†æ•°æ®ã€‚

ğŸ”¹ **ä¸‰æ¨¡å¼è¯»å–API**ï¼šæä¾›ä¸‰ç§è¯»å–æ•°æ®çš„æ–¹å¼

- **é˜»å¡å¼API**ï¼šå…ˆå°è¯•è¯»å–æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™é˜»å¡ç­‰å¾…ï¼ŒAPIé‡‡ç”¨å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œå½“contextè¶…æ—¶ã€åŒç¼“å†²é€šé“å…³é—­æ—¶è¿”å›é”™è¯¯ï¼Œæ”¶åˆ°é€šçŸ¥åˆ™å¤„ç†æ•°æ®ã€‚
- **æ‰¹é‡API**ï¼šæŒ‡å®šæ‰¹é‡è¯»å–æ•°æ®çš„æ¡æ•°ï¼Œå½“æœ‰æ•°æ®éœ€è¦å¤„ç†æ—¶ï¼Œæ‰¹é‡è¿”å›æ•°æ®ï¼ˆå¾…å®ç°ï¼‰ã€‚
- **å›è°ƒå‡½æ•°å¤„ç†**ï¼šæ³¨å†Œå›è°ƒå‡½æ•°ï¼Œå½“æ•°æ®éœ€è¦å¤„ç†æ—¶ï¼Œè°ƒç”¨æ³¨å†Œçš„å›è°ƒå‡½æ•°å¤„ç†æ•°æ®ï¼ˆå¾…å®ç°ï¼‰ã€‚

ğŸ”¹ **åŒæ¨¡å¼è¯»å–æœºåˆ¶**ï¼š
- **å®‰å…¨è¯»å–æœºåˆ¶**ï¼š
    - å½“æ•°æ®å¤§å°å°äº1024å­—èŠ‚æ—¶ï¼Œå¤åˆ¶æ•°æ®å¹¶è¿”å›ï¼›
    - å½“æ•°æ®å¤§äº1024å­—èŠ‚ä¸”å°äº32KBï¼Œæ•°æ®æŒ‡é’ˆæœ‰æ•ˆï¼Œåˆ™é›¶æ‹·è´è¿”å›æ•°æ®ï¼Œåä¹‹åˆ™å¤åˆ¶æ•°æ®å¹¶è¿”å›ï¼Œé›¶æ‹·è´è¿›è¡Œç”Ÿå‘½å‘¨æœŸç®¡ç†(å¼•ç”¨è®¡æ•°ç®¡ç†)ï¼›
    - å½“æ•°æ®å¤§äº32KBï¼Œåˆ™ç›´æ¥é›¶æ‹·è´è¿”å›æ•°æ®ï¼Œé›¶æ‹·è´è¿›è¡Œç”Ÿå‘½å‘¨æœŸç®¡ç†(å¼•ç”¨è®¡æ•°ç®¡ç†)ï¼›
- **é›¶æ‹·è´è¯»å–æœºåˆ¶**ï¼šæ‰€æœ‰æ•°æ®å…¨éƒ¨ä»¥é›¶æ‹·è´è¿”å›æ•°æ®ï¼Œé›¶æ‹·è´è¿›è¡Œç”Ÿå‘½å‘¨æœŸç®¡ç†(å¼•ç”¨è®¡æ•°ç®¡ç†)ï¼›

ğŸ”¹ **å®Œå–„ç›‘æ§çš„è®¾è®¡**ï¼šå®Œå–„çš„ç›‘æ§æŒ‡æ ‡è®¾è®¡ï¼Œæ”¯æŒPrometheuså’ŒOpenTelemetryï¼Œç›®å‰å·²æ”¯æŒPrometheusæŒ‡æ ‡ï¼ŒæŠ½è±¡æ‰¹é‡ä¸ŠæŠ¥æ¥å£ï¼Œ
ä¸ŠæŠ¥æŒ‡æ ‡æ•°æ®å®šæ—¶æ‰¹é‡åˆ·æ–°åˆ°åº•å±‚æŒ‡æ ‡é‡‡é›†å™¨ã€‚


## ğŸš€ Performance
- **System architecture**: darwin/arm64
- **processor**: Apple M4

### 128B Test results
```text
# Zero copy mode
BenchmarkBlockingRead_Throughput_Zero_Copy_128Bytes-10    	 4261556	       293.7 ns/op
BenchmarkBlockingRead_Throughput_Zero_Copy_128Bytes-10    	 4243588	       278.8 ns/op
BenchmarkBlockingRead_Throughput_Zero_Copy_128Bytes-10    	 4145382	       282.2 ns/op
BenchmarkBlockingRead_Throughput_Zero_Copy_128Bytes-10    	 4110026	       284.3 ns/op

# Safe read mode
BenchmarkBlockingRead_Throughput_Safe_Read_128Bytes-10    	 3553357	       335.4 ns/op
BenchmarkBlockingRead_Throughput_Safe_Read_128Bytes-10    	 3291746	       335.5 ns/op
BenchmarkBlockingRead_Throughput_Safe_Read_128Bytes-10    	 3459871	       333.0 ns/op
BenchmarkBlockingRead_Throughput_Safe_Read_128Bytes-10    	 3500275	       335.0 ns/op
```

### 64KB Test results
```text
# Zero copy mode
BenchmarkBlockingRead_Throughput_Zero_Copy_64KB_10    	 9410623	       129.3 ns/op
BenchmarkBlockingRead_Throughput_Zero_Copy_64KB_10    	 9096145	       129.4 ns/op
BenchmarkBlockingRead_Throughput_Zero_Copy_64KB_10    	 9354147	       129.4 ns/op
BenchmarkBlockingRead_Throughput_Zero_Copy_64KB_10    	 9155121	       129.9 ns/op

# Safe read mode
BenchmarkBlockingRead_Throughput_Safe_Read_64KB-10    	 9770590	       124.2 ns/op
BenchmarkBlockingRead_Throughput_Safe_Read_64KB-10    	 9383720	       123.8 ns/op
BenchmarkBlockingRead_Throughput_Safe_Read_64KB-10    	 9513310	       123.7 ns/op
BenchmarkBlockingRead_Throughput_Safe_Read_64KB-10    	 9623844	       125.2 ns/op
```

## ç›‘æ§æŒ‡æ ‡è¯´æ˜

### å…¨å±€å‘½åç©ºé—´
æ‰€æœ‰æŒ‡æ ‡å‡ä»¥ `TurboStream_` ä½œä¸ºå‘½åç©ºé—´å‰ç¼€

---

### å†™å…¥ç›¸å…³æŒ‡æ ‡
| æŒ‡æ ‡åç§°                           | ç±»å‹       | æ ‡ç­¾/ç»´åº¦       | æè¿°                                                                 |
|------------------------------------|------------|-----------------|----------------------------------------------------------------------|
| `TurboStream_write_counts_total`       | CounterVec | `result`        | å†™å…¥æ“ä½œæ€»æ•°ï¼ˆæ ‡ç­¾å€¼ï¼š`success` æˆåŠŸ / `failure` å¤±è´¥ï¼‰               |
| `TurboStream_write_sizes_total`        | Counter    | -               | å·²å†™å…¥æ•°æ®çš„æ€»å­—èŠ‚æ•°ï¼ˆå•ä½ï¼šå­—èŠ‚ï¼‰                                   |
| `TurboStream_write_errors_total`       | Counter    | -               | å†™å…¥å¤±è´¥çš„æ¬¡æ•°ï¼ˆå«ç½‘ç»œé”™è¯¯ã€æ ¡éªŒå¤±è´¥ç­‰åœºæ™¯ï¼‰                         |

---

### è¯»å–ç›¸å…³æŒ‡æ ‡
| æŒ‡æ ‡åç§°                           | ç±»å‹       | æ ‡ç­¾/ç»´åº¦       | æè¿°                                                                 |
|------------------------------------|------------|-----------------|----------------------------------------------------------------------|
| `TurboStream_read_counts_total`        | CounterVec | `result`        | è¯»å–æ“ä½œæ€»æ•°ï¼ˆæ ‡ç­¾å€¼ï¼š`success` æˆåŠŸ / `failure` å¤±è´¥ï¼‰               |
| `TurboStream_read_sizes_total`         | Counter    | -               | å·²è¯»å–æ•°æ®çš„æ€»å­—èŠ‚æ•°ï¼ˆå•ä½ï¼šå­—èŠ‚ï¼‰                                   |
| `TurboStream_read_errors_total`        | Counter    | -               | è¯»å–å¤±è´¥çš„æ¬¡æ•°ï¼ˆå«è¶…æ—¶ã€æ ¡éªŒå¤±è´¥ç­‰åœºæ™¯ï¼‰                             |

---

### ç¼“å†²åŒºåˆ‡æ¢æŒ‡æ ‡
| æŒ‡æ ‡åç§°                           | ç±»å‹       | æè¿°                                                                 |
|------------------------------------|------------|----------------------------------------------------------------------|
| `TurboStream_switch_counts_total`      | Counter    | ç¼“å†²åŒºåˆ‡æ¢æ“ä½œæ€»æ¬¡æ•°                                                 |
| `TurboStream_switch_latency`           | Histogram  | åˆ‡æ¢å»¶è¿Ÿåˆ†å¸ƒï¼ˆå•ä½ï¼šç§’ï¼Œé¢„è®¾æ¡¶è¾¹ç•Œï¼š[0.001, 0.005, 0.01, 0.05, 0.1]ï¼‰|
| `TurboStream_skip_switch_counts_total` | Counter    | å®šæ—¶ä»»åŠ¡è·³è¿‡åˆ‡æ¢çš„æ¬¡æ•°ï¼ˆæœªè¾¾åˆ°åˆ‡æ¢æ¡ä»¶æ—¶è®¡æ•°ï¼‰                       |

---

### å¼‚æ­¥å¤„ç†æŒ‡æ ‡
| æŒ‡æ ‡åç§°                           | ç±»å‹       | æè¿°                                                                 |
|------------------------------------|------------|----------------------------------------------------------------------|
| `TurboStream_async_workers`            | Gauge      | å½“å‰æ´»è·ƒçš„å¼‚æ­¥å·¥ä½œåç¨‹æ•°é‡                                           |

---

### ç¼“å†²æ± æŒ‡æ ‡
| æŒ‡æ ‡åç§°                           | ç±»å‹       | æè¿°                                                                 |
|------------------------------------|------------|----------------------------------------------------------------------|
| `TurboStream_pool_alloc_total`         | Counter    | å¯¹è±¡æ± å†…å­˜åˆ†é…æ¬¡æ•°                                                   |

---

### é€šé“çŠ¶æ€æŒ‡æ ‡
| æŒ‡æ ‡åç§°                           | ç±»å‹       | æè¿°                                                                 |
|------------------------------------|------------|----------------------------------------------------------------------|
| `TurboStream_active_channel_data_counts` | Gauge    | å½“å‰æ´»è·ƒé€šé“ä¸­æœªå¤„ç†çš„æ•°æ®æ¡ç›®æ•°é‡                                   |
| `TurboStream_active_channel_data_sizes`  | Gauge    | å½“å‰æ´»è·ƒé€šé“ä¸­æœªå¤„ç†çš„æ•°æ®æ€»å¤§å°ï¼ˆå•ä½ï¼šå­—èŠ‚ï¼‰                       |

---

### æŒ‡æ ‡ç±»å‹è¯´æ˜
| ç±»å‹        | ç‰¹æ€§                                                                 |
|-------------|----------------------------------------------------------------------|
| **Counter**   | åªå¢ä¸å‡çš„ç´¯ç§¯è®¡æ•°å™¨ï¼Œé€‚ç”¨äºè¯·æ±‚æ•°ã€é”™è¯¯æ•°ç­‰ç»Ÿè®¡                     |
| **Gauge**     | å¯ä»»æ„å˜åŒ–çš„ç¬æ—¶å€¼ï¼Œé€‚ç”¨äºå®æ—¶èµ„æºç”¨é‡ï¼ˆå¦‚å†…å­˜ã€åç¨‹æ•°ï¼‰             |
| **Histogram** | æµ‹é‡è§‚æµ‹å€¼çš„åˆ†å¸ƒï¼Œè‡ªåŠ¨è®¡ç®—åˆ†ä½æ•°ï¼Œé€‚ç”¨äºå»¶è¿Ÿã€å“åº”å¤§å°ç­‰æŒ‡æ ‡         |
| **CounterVec**| å¸¦æ ‡ç­¾çš„è®¡æ•°å™¨ï¼Œæ”¯æŒå¤šç»´ç»†åˆ†ç»Ÿè®¡ï¼ˆå¦‚æŒ‰æˆåŠŸ/å¤±è´¥çŠ¶æ€åˆ†ç±»ï¼‰            |

---

## ç¤ºä¾‹ PromQL æŸ¥è¯¢
```promql
# è®¡ç®—å†™å…¥ååé‡ï¼ˆæ¬¡/ç§’ï¼‰
rate(TurboStream_write_counts_total[1m])

# è·å–æ´»è·ƒé€šé“æ•°æ®ç§¯å‹å‘Šè­¦ï¼ˆ>1MB æŒç»­5åˆ†é’Ÿï¼‰
TurboStream_active_channel_data_sizes > 1e6

# ç»Ÿè®¡åˆ‡æ¢å»¶è¿Ÿçš„P99å€¼
histogram_quantile(0.99, sum(rate(TurboStream_switch_latency_bucket[5m])) by (le))
```

## ğŸ“¦ Installation
```bash
go get github.com/TimeWtr/TurboStream
```
## ğŸ§© ç”¨æ³•
å¾…è¡¥å……ï¼